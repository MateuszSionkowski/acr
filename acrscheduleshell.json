{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "acrName": { "type": "string" },
    "location": { "type": "string", "defaultValue": "eastus" },
    "tag": { "type": "string", "defaultValue": "latest" },
    "externalRepoPath": { "type": "string", "defaultValue": "docker.io/library/nginx" },
    "localRepoName": { "type": "string", "defaultValue": "nginx" }
  },
  "resources": [
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2022-12-01",
      "name": "[parameters('acrName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Basic" },
      "properties": { "adminUserEnabled": true }
    },
    {
      "type": "Microsoft.ContainerRegistry/registries/tasks",
      "apiVersion": "2019-06-01-preview",
      "name": "[concat(parameters('acrName'), '/pullExternalImage')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
      ],
      "properties": {
        "status": "Enabled",
        "platform": { "os": "Linux" },
        "agentConfiguration": { "cpu": 2 },
        "step": {
          "type": "Shell",
          "script": "echo \"Pulling external image\" && \\\n\
docker pull [parameters('externalRepoPath')]:[parameters('tag')] && \\\n\
SOURCE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' [parameters('externalRepoPath')]:[parameters('tag')] | cut -d@ -f2) && \\\n\
LOCAL_IMAGE=[parameters('acrName')].azurecr.io/[parameters('localRepoName')] && \\\n\
EXISTING_DIGEST=$(docker manifest inspect $LOCAL_IMAGE:[parameters('tag')] 2>/dev/null | jq -r '{{.manifests[0].digest}}') && \\\n\
if [ \"$SOURCE_DIGEST\" = \"$EXISTING_DIGEST\" ]; then echo \"No change in image\"; exit 0; fi && \\\n\
DATE_TAG=$(date +%Y%m%d) && \\\n\
docker tag [parameters('externalRepoPath')]:[parameters('tag')] $LOCAL_IMAGE:[parameters('tag')] && \\\n\
docker tag [parameters('externalRepoPath')]:[parameters('tag')] $LOCAL_IMAGE:$DATE_TAG && \\\n\
docker push $LOCAL_IMAGE:[parameters('tag')] && docker push $LOCAL_IMAGE:$DATE_TAG"
        },
        "trigger": {
          "type": "Schedule",
          "schedule": {
            "type": "TimeBased",
            "status": "Enabled",
            "recurrence": {
              "frequency": "Day",
              "interval": 1
            },
            "time": "02:00"
          }
        }
      }
    }
  ]
}
